name: Check And Calculate PKG_MIRROR_HASH

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
#    inputs:
#      target_version:
#        description: 'Target OpenWrt version. if empty the simple mode will be used.'
#        required: false
#        type: string
  push:
    branches:
      - "main"
    paths:
      - "Makefile"

permissions:
  contents: write

jobs:
  check_and_calc:
    name: Check upstream and calculate PKG_MIRROR_HASH
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check.outputs.updated }}
      new_ver: ${{ steps.check.outputs.new_ver }}
      new_hash: ${{ steps.calc.outputs.NEW_HASH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: üîç Check for updates
        id: check
        run: |
          set -euo pipefail

          UPSTREAM_URL="https://github.com/tfslabs/vlmcsd.git"
          API_URL="https://api.github.com/repos/tfslabs/vlmcsd/commits"
          CURRENT_VER=$(grep '^PKG_SOURCE_VERSION:=' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')
          REMOTE_VER=$(git ls-remote $UPSTREAM_URL HEAD | awk '{print $1}')
          echo "Current: $CURRENT_VER"
          echo "Remote:  $REMOTE_VER"

          if [ -z "$REMOTE_VER" ]; then
            echo "‚ùå Failed to get remote version."
            exit 1
          fi

          if [ "$CURRENT_VER" = "$REMOTE_VER" ]; then
            echo "‚úÖ Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üöÄ New version found! Updating..."

          COMMIT_JSON=$(curl -s "${API_URL}/${REMOTE_VER}")
          NEW_DATE=$(echo "$COMMIT_JSON" | jq -r '.commit.committer.date' | cut -d'T' -f1)

          if [ -z "$NEW_DATE" ] || [ "$NEW_DATE" = "null" ]; then
             NEW_DATE=$(date +%Y-%m-%d)
          fi

          sed -i "s|^PKG_SOURCE_VERSION:=.*|PKG_SOURCE_VERSION:=$REMOTE_VER|" Makefile
          sed -i "s|^PKG_SOURCE_DATE:=.*|PKG_SOURCE_DATE:=$NEW_DATE|" Makefile

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_ver=$REMOTE_VER" >> $GITHUB_OUTPUT

      - name: üìõ Extract PKG_NAME
        run: |
          PKG_NAME=$(grep -E '^PKG_NAME[:?]?=' Makefile | head -n1 | sed -E 's/PKG_NAME[:?]?= *//')
          echo "PKG_NAME=$PKG_NAME" >> "$GITHUB_ENV"

      - name: üì• Download sha256sums
        run: |
          BASE_URL="https://downloads.openwrt.org/releases/24.10.5/targets/x86/64"
          wget -q ${BASE_URL}/sha256sums
          echo "BASE_URL=$BASE_URL" >> "$GITHUB_ENV"

      - name: üîë Extract SDK hash
        id: sdk-hash
        run: |
          HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: ‚ôªÔ∏è Cache OpenWrt SDK
        id: cache
        if: steps.check.outputs.updated == 'true'
        uses: actions/cache@v5
        with:
          path: openwrt-sdk
          key: sdk-${{ runner.os }}-${{ steps.sdk-hash.outputs.hash }}-${{ hashFiles('Makefile') }}
          restore-keys: sdk-${{ runner.os }}-${{ steps.sdk-hash.outputs.hash }}-

      - name: üì¶ Download & Extract OpenWrt SDK
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if [ -d "openwrt-sdk" ]; then
            echo "‚ôªÔ∏è SDK restored from partial cache (restore-keys). Skipping download."
            exit 0
          fi
          SDK_FILE=$(grep "openwrt-sdk" sha256sums | awk '{print $2}' | sed 's/^\*//')
          SDK_HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          echo "Downloading SDK: $SDK_FILE"
          wget -q ${BASE_URL}/${SDK_FILE}
          echo "${SDK_HASH}  ${SDK_FILE}" | sha256sum -c -
          tar -I zstd -xf ${SDK_FILE}
          SDK_DIR=$(tar -tf ${SDK_FILE} | awk -F/ 'NR==1 {print $1; exit}')
          mv "$SDK_DIR" openwrt-sdk

      - name: üîó Link package into SDK
        run: |
          mkdir -p openwrt-sdk/package/custom/${PKG_NAME}
          rsync -a ./ openwrt-sdk/package/custom/${PKG_NAME}/ \
            --exclude 'openwrt-sdk' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'LICENSE' \
            --exclude 'README.md' \
            --exclude 'SECURITY.md'

      - name: üîç Download and Calculate Hash manually
        id: calc
        run: |
          cd openwrt-sdk
          make defconfig
          rm -f dl/${PKG_NAME}-*.tar.*
          rm -rf build_dir/*/${PKG_NAME}*

          echo "‚¨áÔ∏è Downloading source (Ignoring existing hash)..."
          make package/custom/${PKG_NAME}/download PKG_MIRROR_HASH=skip V=s
          
          DOWNLOADED_FILE=$(find dl -type f -name "${PKG_NAME}*" | head -n 1)
          if [ -z "$DOWNLOADED_FILE" ]; then
            echo "‚ùå Error: No file found in openwrt-sdk/dl/"
            echo "Listing dl directory:"
            ls -R dl/
            exit 1
          fi
          echo "üì¶ Found file: $DOWNLOADED_FILE"
          NEW_HASH=$(sha256sum "$DOWNLOADED_FILE" | awk '{print $1}')
          echo "üßÆ Calculated Hash: $NEW_HASH"
          echo "NEW_HASH=$NEW_HASH" >> $GITHUB_OUTPUT

      - name: üìù Update PKG_MIRROR_HASH if needed
        run: |
          NEW_HASH="${{ steps.calc.outputs.NEW_HASH }}"
          OLD_HASH=$(grep '^PKG_MIRROR_HASH' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')
          
          echo "Old Hash: $OLD_HASH"
          echo "New Hash: $NEW_HASH"
          
          if [ -z "$NEW_HASH" ]; then
            echo "‚ùå Failed to calculate new hash."
            exit 1
          fi
          
          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "‚ÑπÔ∏è Hash unchanged, no commit needed."
            exit 0
          fi
          
          sed -i "s|^PKG_MIRROR_HASH.*|PKG_MIRROR_HASH:=$NEW_HASH|" Makefile
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Makefile
          git commit -m "Update-PKG_MIRROR_HASH to $NEW_HASH"
          git push
